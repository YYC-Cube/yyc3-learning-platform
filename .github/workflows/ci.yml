name: CI/CD Pipeline - YYCÂ³ Learning Platform

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [created]

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: yyc3-learning-platform

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-and-format:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½® npm ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: npm run type-check

      - name: ESLint ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: Prettier æ ¼å¼æ£€æŸ¥
        run: npm run format:check

      - name: Stylelint CSS æ£€æŸ¥
        run: npm run lint:css

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: è®¾ç½® npm ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: npm run test:unit
        env:
          CI: true

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: npm run test:coverage

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šåˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: true

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: lint-and-format
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ai_learning_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
        run: |
          echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/ai_learning_test" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379" >> $GITHUB_ENV
          echo "NEXTAUTH_SECRET=test-secret" >> $GITHUB_ENV
          echo "NEXTAUTH_URL=http://localhost:3000" >> $GITHUB_ENV

      - name: è¿è¡Œæ•°æ®åº“è¿ç§»
        run: npm run db:migrate

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: npm run test:integration

  # ç«¯åˆ°ç«¯æµ‹è¯•
  e2e-tests:
    name: ç«¯åˆ°ç«¯æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install --with-deps

      - name: æ„å»ºåº”ç”¨
        run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: http://localhost:3000/api

      - name: å¯åŠ¨åº”ç”¨
        run: npm run start &
        env:
          PORT: 3000

      - name: ç­‰å¾…åº”ç”¨å¯åŠ¨
        run: npx wait-on http://localhost:3000

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: npm run test:e2e

      - name: ä¸Šä¼  E2E æµ‹è¯•æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: ä¸Šä¼  Trivy æ‰«æç»“æœåˆ° GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: è¿è¡Œ Snyk å®‰å…¨æ‰«æ
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ä¾èµ–æ¼æ´æ‰«æ
        run: |
          pnpm audit --audit-level high --production

      - name: æ£€æŸ¥ç¡¬ç¼–ç å¯†é’¥
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
          fail-on-secret: true

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºåº”ç”¨
        run: pnpm run build

      - name: å¯åŠ¨åº”ç”¨
        run: pnpm run start &

      - name: ç­‰å¾…åº”ç”¨å¯åŠ¨
        run: npx wait-on http://localhost:3000

      - name: è¿è¡Œ Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # æ„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºåº”ç”¨
        run: pnpm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.PRODUCTION_API_URL }}
          NEXT_PUBLIC_APP_VERSION: ${{ github.sha }}

      - name: éƒ¨ç½²åˆ° Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-args: '--prod'
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}

      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸï¼"
          echo "åº”ç”¨å·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"

  # é¢„è§ˆç¯å¢ƒéƒ¨ç½²
  preview-deploy:
    name: é¢„è§ˆç¯å¢ƒéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'pull_request'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºåº”ç”¨
        run: pnpm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.PREVIEW_API_URL }}

      - name: éƒ¨ç½²é¢„è§ˆç¯å¢ƒ
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}

  # é€šçŸ¥
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-deploy, preview-deploy]
    if: always()
    steps:
      - name: å‘é€é’‰é’‰é€šçŸ¥
        if: needs.build-and-deploy.result == 'success'
        run: |
          curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "ğŸ‰ YanYu Smart CloudÂ³ Learning Hub éƒ¨ç½²æˆåŠŸï¼\nåˆ†æ”¯: ${{ github.ref }}\næäº¤: ${{ github.sha }}\nä½œè€…: ${{ github.actor }}"
              }
            }'

      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: needs.build-and-deploy.result == 'failure'
        run: |
          curl -X POST ${{ secrets.DINGTALK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "âŒ YanYu Smart CloudÂ³ Learning Hub éƒ¨ç½²å¤±è´¥ï¼\nåˆ†æ”¯: ${{ github.ref }}\næäº¤: ${{ github.sha }}\nä½œè€…: ${{ github.actor }}\nè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—"
              }
            }'

  # Docker é•œåƒæ„å»ºå’Œæ¨é€
  docker-build-push:
    name: Docker é•œåƒæ„å»ºå’Œæ¨é€
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            NEXT_PUBLIC_API_BASE_URL=${{ secrets.PRODUCTION_API_URL }}
            NEXT_PUBLIC_APP_VERSION=${{ github.sha }}

      - name: ç”Ÿæˆé•œåƒ SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: spdx-json
          output-file: sbom.json

      - name: ä¸Šä¼  SBOM
        uses: actions/upload-artifact@v3
        with:
          name: sbom
          path: sbom.json

  # Kubernetes éƒ¨ç½²ï¼ˆè“ç»¿éƒ¨ç½²ï¼‰
  kubernetes-deploy:
    name: Kubernetes è“ç»¿éƒ¨ç½²
    runs-on: ubuntu-latest
    needs: [docker-build-push]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://yyc3-learning.yyc3.0379.email
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: é…ç½® kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: éªŒè¯é›†ç¾¤è¿æ¥
        run: kubectl cluster-info

      - name: åˆ›å»ºå‘½åç©ºé—´ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        run: |
          kubectl create namespace yyc3-learning --dry-run=client -o yaml | kubectl apply -f -

      - name: éƒ¨ç½² ConfigMap å’Œ Secret
        run: |
          kubectl apply -f k8s/configmap.yaml -n yyc3-learning
          kubectl apply -f k8s/secret.yaml -n yyc3-learning

      - name: æ›´æ–°é•œåƒæ ‡ç­¾
        run: |
          sed -i "s|IMAGE_TAG|${{ github.sha }}|g" k8s/deployment.yaml

      - name: è“ç»¿éƒ¨ç½² - åˆ›å»ºæ–°ç‰ˆæœ¬
        run: |
          CURRENT_COLOR=$(kubectl get deployment yyc3-learning -n yyc3-learning -o jsonpath='{.spec.template.metadata.labels.color}' 2>/dev/null || echo "blue")
          NEW_COLOR=$([ "$CURRENT_COLOR" = "blue" ] && echo "green" || echo "blue")
          
          echo "CURRENT_COLOR=$CURRENT_COLOR"
          echo "NEW_COLOR=$NEW_COLOR"
          
          sed -i "s|COLOR|$NEW_COLOR|g" k8s/deployment.yaml
          
          kubectl apply -f k8s/deployment.yaml -n yyc3-learning
          
          echo "NEW_COLOR=$NEW_COLOR" >> $GITHUB_ENV

      - name: ç­‰å¾…æ–°ç‰ˆæœ¬ Pod å°±ç»ª
        run: |
          kubectl rollout status deployment/yyc3-learning -n yyc3-learning --timeout=5m

      - name: å¥åº·æ£€æŸ¥
        run: |
          kubectl wait --for=condition=ready pod -l app=yyc3-learning,color=$NEW_COLOR -n yyc3-learning --timeout=3m
          
          POD_IP=$(kubectl get pod -l app=yyc3-learning,color=$NEW_COLOR -n yyc3-learning -o jsonpath='{.items[0].status.podIP}')
          
          for i in {1..30}; do
            if curl -f http://$POD_IP:3000/health; then
              echo "å¥åº·æ£€æŸ¥é€šè¿‡"
              exit 0
            fi
            echo "ç­‰å¾…å¥åº·æ£€æŸ¥... ($i/30)"
            sleep 10
          done
          
          echo "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè§¦å‘å›æ»š"
          exit 1

      - name: åˆ‡æ¢æµé‡åˆ°æ–°ç‰ˆæœ¬
        run: |
          kubectl patch service yyc3-learning -n yyc3-learning -p '{"spec":{"selector":{"color":"'$NEW_COLOR'"}}}'

      - name: éªŒè¯æ–°ç‰ˆæœ¬æµé‡
        run: |
          SERVICE_IP=$(kubectl get service yyc3-learning -n yyc3-learning -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          
          for i in {1..10}; do
            RESPONSE=$(curl -s http://$SERVICE_IP:3000/api/health)
            if echo "$RESPONSE" | grep -q "status.*ok"; then
              echo "æµé‡åˆ‡æ¢éªŒè¯é€šè¿‡"
              exit 0
            fi
            echo "ç­‰å¾…æµé‡åˆ‡æ¢... ($i/10)"
            sleep 5
          done

      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        run: |
          OLD_COLOR=$([ "$NEW_COLOR" = "blue" ] && echo "green" || echo "blue")
          kubectl scale deployment yyc3-learning -n yyc3-learning --replicas=0 || true
          
          echo "æ—§ç‰ˆæœ¬ $OLD_COLOR å·²æ¸…ç†"

      - name: å¤‡ä»½éƒ¨ç½²çŠ¶æ€
        run: |
          kubectl get deployment yyc3-learning -n yyc3-learning -o yaml > deployment-backup-$(date +%Y%m%d-%H%M%S).yaml
          
          kubectl get pods -n yyc3-learning -o wide > pods-backup-$(date +%Y%m%d-%H%M%S).txt

      - name: ä¸Šä¼ å¤‡ä»½æ–‡ä»¶
        uses: actions/upload-artifact@v3
        with:
          name: k8s-backup
          path: |
            deployment-backup-*.yaml
            pods-backup-*.txt
          retention-days: 30

      - name: éƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
        if: failure()
        run: |
          echo "éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œè‡ªåŠ¨å›æ»š..."
          
          kubectl rollout undo deployment/yyc3-learning -n yyc3-learning
          
          kubectl rollout status deployment/yyc3-learning -n yyc3-learning --timeout=5m
          
          echo "å›æ»šå®Œæˆ"

  # æ•°æ®åº“å¤‡ä»½
  database-backup:
    name: æ•°æ®åº“å¤‡ä»½
    runs-on: ubuntu-latest
    needs: [kubernetes-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: å®‰è£… PostgreSQL å®¢æˆ·ç«¯
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: åˆ›å»ºæ•°æ®åº“å¤‡ä»½
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_FILE="yyc3-learning-backup-$TIMESTAMP.sql.gz"
          
          PGPASSWORD="${{ secrets.DB_PASSWORD }}" pg_dump \
            -h ${{ secrets.DB_HOST }} \
            -p ${{ secrets.DB_PORT }} \
            -U ${{ secrets.DB_USER }} \
            -d ${{ secrets.DB_NAME }} \
            -F c \
            -f $BACKUP_FILE
          
          echo "BACKUP_FILE=$BACKUP_FILE" >> $GITHUB_ENV

      - name: ä¸Šä¼ å¤‡ä»½åˆ° S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --acl private
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          SOURCE_DIR: './'
          DEST_DIR: 'backups/yyc3-learning/'

      - name: æ¸…ç†è¿‡æœŸå¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘ 30 å¤©ï¼‰
        run: |
          aws s3 ls s3://${{ secrets.AWS_S3_BUCKET }}/backups/yyc3-learning/ \
            | awk '{print $2}' \
            | while read backup; do
              backup_date=$(echo $backup | sed 's/\///')
              if [ $(date -d "$backup_date" +%s) -lt $(date -d "30 days ago" +%s) ]; then
                aws s3 rm s3://${{ secrets.AWS_S3_BUCKET }}/backups/yyc3-learning/$backup
              fi
            done

  # ç›‘æ§å’Œå‘Šè­¦
  monitoring-setup:
    name: ç›‘æ§å’Œå‘Šè­¦è®¾ç½®
    runs-on: ubuntu-latest
    needs: [kubernetes-deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: é…ç½® kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: éƒ¨ç½² Prometheus å’Œ Grafana
        run: |
          kubectl apply -f k8s/monitoring/prometheus.yaml -n yyc3-learning
          kubectl apply -f k8s/monitoring/grafana.yaml -n yyc3-learning

      - name: éƒ¨ç½²å‘Šè­¦è§„åˆ™
        run: |
          kubectl apply -f k8s/monitoring/alert-rules.yaml -n yyc3-learning

      - name: é…ç½®å‘Šè­¦é€šçŸ¥
        run: |
          kubectl create secret generic alertmanager-config \
            --from-literal=webhook-url="${{ secrets.ALERT_WEBHOOK }}" \
            --dry-run=client -o yaml | kubectl apply -f - -n yyc3-learning
